function publish_to_wall(e,t){FB.ui({method:"feed",link:e,caption:t,description:"Raindrops ~ Easy way to save your ideas and share.",name:"Check this raindrop on "},function(e){e&&e.post_id&&$("#fb_publish").html("<img id='fb_publogo' src='"+this.model.get("server")+"/assets/images/fb_logo.png'/>Done!")})}var App={Viewer:""};App.Viewer={Models:{},Collections:{},Views:{},Routers:{},init:function(){"use strict";return rd.embed===!0?new App.Viewer.Views.EmbedView:"scroll"===rd.type?new App.Viewer.Views.ScrollView:"slide"===rd.type?new App.Viewer.Views.ScrollView:"study"===rd.type?new App.Viewer.Views.StudyView:"notes"===rd.type?new App.Viewer.Views.ScrollView:void 0}},$(document).ready(function(){document.title=rd.name.substring(0,20).trim()+" : raindrops",$(document).foundation({offcanvas:{open_method:"move",close_on_click:!0}},"abide","reflow","accordion"),App.Viewer.init(),$("base").attr("href",window.location.href)}),App.Viewer.Utils={fitTitle:function(e){var t;t=e?$(e).find("#title-container"):$("#title-container"),t?(t.textfill({maxFontPixels:63,changeLineHeight:!0}),t.find("p").css({visibility:"visible"})):console.log("find")},checkMath:function(){function e(){s.model.set("math",!0)}function t(){window.status="done"}var s=this;MathJax.Hub.Queue(["Typeset",MathJax.Hub,"pages"]),MathJax.Hub.Queue(e),MathJax.Hub.Queue(t)},shareButtons:function(){var e=$("#sharePlugin"),t=$("#shareme"),s=$("#fb_publish"),i={share:{googlePlus:!0,facebook:!0,twitter:!0},buttons:{googlePlus:{size:"medium",annotation:"bubble"},facebook:{size:"medium",layout:"button_count"},twitter:{count:"horizontal"}},urlCurl:"rest/sharrre.php",text:document.title+" by "+this.model.get("user"),enableHover:!1,enableCounter:!1,enableTracking:!1};e.show(),e.data({url:document.location.href}),t.sharrre(i),s.data("link",document.location.href),s.data("caption",document.title+" by "+this.model.get("user")),s.show()},showAuthors:function(e,t){var s=this,i="../../rest/name",n={url:i,type:"GET",data:{users:this.model.get("authors")},dataType:"json"},r=function(i){var n="",r=void 0;for(var o in i)r=i[o],n+='<a target="_blank" class="user username" href="'+o+'"> '+r+"</a>,";n=n.substring(0,n.length-1),$(".author").html(n),e.hide(),t||s.fullScreenOverlay()},o=function(){return e.hide(),!1};return $.ajax(n).success(r).error(o)},fbPublish:function(e){function t(e,t){FB.ui({method:"feed",link:e,caption:t,description:"Raindrops ~ Easy way to save your ideas and share.",name:"Check this raindrop on "},function(e){e&&e.post_id&&$("#fb_publish").html("<img id='fb_publogo' src='"+this.model.get("server")+"/assets/images/fb_logo.png'/>Done!")})}e||(window.fbAsyncInit=function(){FB.init({appId:303281363147508,status:!0,cookie:!0,xfbml:!0})},function(){var e=document.createElement("script");e.async=!0,e.src=document.location.protocol+"//connect.facebook.net/en_US/all.js",document.getElementById("fb-root").appendChild(e)}(),$("#popup_content").on("click","#fb_publish",function(){t($(this).data("link"),$(this).data("caption"))}),$(".main-section").on("click","#fb_publish",function(){t($(this).data("link"),$(this).data("caption"))}))},answerClickHandler:function(e){var t=$(e.currentTarget);$("#ans-"+t.data("id")).css({visibility:"visible",marginTop:0}),t.hide()},fullScreenOverlay:function(){function e(){$(".reveal-modal-bg").height("auto"),$("#fullscreen").foundation("reveal","close")}function t(){e(),$("#open-fullscreen").trigger("click")}console.log(this.model),this.model.get("fullscreen")&&($("body").scrollTop(0),$("#fullscreen").foundation("reveal","open"),$(".reveal-modal-bg").height($(window).height()),$("span#go-fullscreen").click(t))},openSinglePage:function(e){e.preventDefault(),window.open(this.model.get("server")+"/view?id="+this.model.get("id")+"&view=notes","_self")},openScrollMode:function(e){e.preventDefault(),window.open(this.model.get("server")+"/view?id="+this.model.get("id")+"&view=scroll","_self")},openSlideMode:function(e){e.preventDefault(),window.open(this.model.get("server")+"/view?id="+this.model.get("id")+"&view=slide","_self")},openStudyMode:function(e){e.preventDefault(),window.open(this.model.get("server")+"/view?id="+this.model.get("id")+"&view=study","_self")},openPDF:function(e){e.preventDefault(),"notes"===this.model.get("mode")?window.open(this.model.get("server")+"/print?id="+this.model.get("id")+"&p=1","_blank"):window.open(this.model.get("server")+"/print?id="+this.model.get("id"),"_blank")},hex2rgb:function(e,t){var s,i,n;return e?("#"==e.charAt(0)&&(e=e.substr(1)),6==e.length?(s=e.charAt(0)+e.charAt(1),i=e.charAt(2)+e.charAt(3),n=e.charAt(4)+e.charAt(5)):3==e.length&&(s=e.charAt(0)+"f",i=e.charAt(1)+"f",n=e.charAt(2)+"f"),s=parseInt(s,16),i=parseInt(i,16),n=parseInt(n,16),"none"!==e?"rgba("+s+","+i+","+n+","+t+")":"rgba(0,0,0,0)"):"rgba(0,0,0,0)"}},App.Viewer.Models.raindrop=Backbone.Model.extend({defaults:{currentPage:1,math:!1,fullscreen:!1,frontPage:!0,pages:1,canvasColor:"#000",canvasLineWidth:2,pinPage:void 0},initialize:function(){},changeLike:function(e){var t=this.get("user"),s=this;if(""!==t.trim()){var i={url:"rest/"+t+"/subscriptions",type:"POST",dataType:"json",data:{pid:s.get("id"),collect:!s.get("liked")}},n=function(t){if(0===t.Stat){var i=t.Res.likecount;s.set("likes",i),s.set("liked",!s.get("liked")),e()}return!0},r=function(){return e(),!1};return $.ajax(i).success(n).error(r)}}}),App.Viewer.Views.ShareView=Backbone.View.extend({el:"#popupDialog",setupDOM:function(){this.fb=this.$el.find("#fb_publish"),this.tw=this.$el.find("#tweet_anchor"),this.input=this.$el.find("#popuptext"),this.input.focus(function(){$(this).select()}),this.input.click(function(){$(this).select()})},events:{"click #fb_publish":"publishToFB"},publishToFB:function(){var e=this.data;FB.ui({method:"feed",link:e.link,caption:e.caption,description:"Raindrops ~ Easy way to save your ideas and share.",name:"Check this raindrop on "},function(e){e&&e.post_id&&$("#fb_publish").html("<img id='fb_publogo' src='"+this.model.get("server")+"/assets/images/fb_logo.png'/>Done!")})},openPopup:function(e){this.data=e,this.fb.data("link",e.link),this.fb.data("caption",e.caption),$("#tweet").html(""),$("#tweet").html('<a id="tweet_anchor" data-size="large" data-count="none" data-lang="en" href="https://twitter.com/share" class="twitter-share-button" data-url="'+e.link+'" data-text="'+e.caption+'">Tweet</a>'),this.input.val(e.link),twttr.widgets.load(),$(this.$el).foundation("reveal","open")},initialize:function(e){window.fbAsyncInit=function(){FB.init({appId:303281363147508,status:!0,cookie:!0,xfbml:!0})},function(){var e=document.createElement("script");e.async=!0,e.src=document.location.protocol+"//connect.facebook.net/en_US/all.js",document.getElementById("fb-root").appendChild(e)}(),void 0===window.twttr&&(window.twttr=function(e,t,s){var i,n=e.getElementsByTagName(t)[0];e.getElementById(s)||(i=e.createElement(t),i.id=s,i.src="https://platform.twitter.com/widgets.js",n.parentNode.insertBefore(i,n))}(document,"script","twitter-wjs")),this.vent=e.vent,_.bindAll(this,"openPopup"),this.vent.bind("openPopup",this.openPopup),this.setupDOM()}}),function(e){e.fn.extend({resizeCanvas:function(t,s){var i=e(this)[0];i.width=t,i.height=s}})}(jQuery),App.Viewer.Views.ScrollView=Backbone.View.extend({el:"body",events:{"click #open-embed":"showEmbed","click #backlight":"toggleBackLight","click #open-fullscreen":"goFullscreen","click .menu-icon":"goTop","click input.answer-button":"answerClickHandler","click .popupbutton":"changeEmbed","click #toggle-doodle":"toggleDoodle","click #open-scroll":"openScrollMode","click #open-slide":"openSlideMode","click #open-study":"openStudyMode","click #open-print":"openPDF","click #like":"changeLike","click #share":"shareRaindrop","click #open-notes":"openSinglePage","click .onoffswitch":"toggleDoodle1","click #open-thumbnail":"toggleThumbnail","click #thumbnails > .slide":"goToSlide","click #info":"showInfo"},showInfo:function(e){e.preventDefault(),$("#info").foundation("reveal","open")},goToSlide:function(e){e.stopPropagation();var t=$(e.currentTarget),s="#"+t.prop("id");"slide"===this.model.get("mode")?$("#pages").scrollLeft($("#pages").scrollLeft()+$("#pages").find(s).offset().left-300):$(window).scrollTop($("#pages").find(s).offset().top-40),$(".off-canvas-wrap").foundation("offcanvas","toggle","move-right")},toggleThumbnail:function(e){e.stopPropagation();var t=$(e.currentTarget);t.parent().toggleClass("close")},shareRaindrop:function(e){e.preventDefault();var t={link:this.model.get("server")+"/view?id="+this.model.get("id"),caption:this.model.get("name")+" by "+this.model.get("user")};this.vent.trigger("openPopup",t)},goTop:function(){this.$el.scrollTop(0)},toggleBackLight:function(e){e.preventDefault();var t=$(e.currentTarget);t.find("i").toggleClass("on").toggleClass("off"),this.$el.toggleClass("dark"),t.find("span").text(this.$el.hasClass("dark")?"Bright":"Dark")},toggleDoodle:function(e){e.preventDefault()},toggleDoodle1:function(e){e.stopPropagation();var t=$("input[name=onoffswitch]").is(":checked");t?$(".draw").show():$(".draw").hide()},changeLike:function(e){function t(){s.find("i").toggleClass("loading")}var s=this.$el.find("#like");s.find("i").toggleClass("loading"),e.preventDefault(),this.model.changeLike(t)},getEmbedTemplate:function(){var e='<iframe src="{{src}}" width="{{width}}" height="{{height}}" ';e+='allowfullscreen seamless="seamless" frameBorder="0" ></iframe>';var t=this.model.get("server")+"/embed?id="+this.model.get("id");return e=e.replace("{{src}}",t)},changeEmbed:function(e){var t,s=$(e.currentTarget),i=this.getEmbedTemplate(),n=$("#popuptext"),r=$(".popupbutton");switch(r.removeClass("selected"),s.addClass("selected"),s.prop("id")){case"small-embed":t=i.replace("{{width}}",560).replace("{{height}}",315);break;case"medium-embed":t=i.replace("{{width}}",640).replace("{{height}}",360);break;default:t=i.replace("{{width}}",853).replace("{{height}}",480)}return n.val(t),n.select()},showEmbed:function(e){e.preventDefault(),$("#embed").foundation("reveal","open"),setTimeout(function(){return $("#popuptext").select()},500)},goFullscreen:function(e){if(e.preventDefault(),Modernizr.Touch){var t=navigator.userAgent.toLowerCase(),s=t.indexOf("android")>-1;s&&this.fullscreenHandler(!0)}this.fullscreenHandler(!0)},fullscreenHandler:function(e){if("notes"!==this.model.get("mode")){var t=$("#pages").get(0);if(e)this.model.set("currentPage",0);else if(Modernizr.touch)this.model.set("currentPage",0);else if(null!=document.getBoxObjectFor||null!=window.mozInnerScreenX)this.model.set("currentPage",0);else{var s=document.elementFromPoint($(window).width()/2,$(window).height()/2);for(s=$(s);!s.hasClass("slide")&&"BODY"!==s.prop("tagName");)s=s.parent();this.model.set("currentPage",s?$(s).index():0)}this.model.get("myFullscreen")||(this.model.set("myFullscreen",!0),this.model.get("frontPage")||(this.removedPage=$("#filename").clone(!0,!0),this.removedPageHt=$("#filename").height(),$("#filename").remove(),this.model.get("currentPage")>0&&this.model.set("currentPage",this.model.get("currentPage")-1)),this.model.set("pages",$("#pages .slide").length),$("#pages .slide").eq(this.model.get("currentPage")).addClass("current"),screenfull.toggle(t))}},setToFullscreen:function(){function e(){t.model.set("math",!0)}if("notes"!==this.model.get("mode")&&!this.model.get("print")){var t=this;screenfull.isFullscreen?this.model.get("myFullscreen")&&(this.model.get("math")||(MathJax.Hub.Queue(["Reprocess",MathJax.Hub,"pages"]),MathJax.Hub.Queue(e)),this.enterFullScreen()):($(".page-no").show(),$(".page-no").toggleClass("fs"),$(".page-no").show(),this.exitFullScreen())}},enterFullScreen:function(){function e(){$("#pages .slide").eq(l).find(".page-no.fs").toggle()}var t=this;this.model.set("myFullscreen",!0);var s=window.screen.width,i=window.screen.height,n=1,r=0,o=$("#pages .slide").width(),a=$("#pages .slide").height();n=s/i>16/9?i/a:s/o,r=(i-n*a)/2,this.model.get("math")||MathJax.Hub.Queue(["Reprocess",MathJax.Hub,"printarea"]),$("#pages .page-no").toggleClass("fs");var l=t.model.get("currentPage");setTimeout(e,2e3),$("#pages .slide").swipe(this.swipeOptions),this.style.innerHTML="body,body.dark{background:black;}.section{margin:0px;position:absolute;top:0px;left:0px;background:rgba(0,0,0,0);} .page-no{z-index:10000} .left-slide{ display:none}#sharePlugin{display:none} #pages .slide{position:fixed;top:0px;left:0px;} #pages .slide:not(.current){display:none;}  #pages .current{-webkit-transform:scale("+n+","+n+");-o-transform:scale("+n+","+n+");-moz-transform:scale("+n+","+n+");transform:scale("+n+","+n+");margin:0px;position:absolute;top:"+Math.floor(r)+"px; transform-origin: top left}",this.goToPage(this.model.get("currentPage"))},exitFullScreen:function(){this.model.set("myFullscreen",!1),this.style.innerHTML="#pages .current{-webkit-transform:scale(1,1);-o-transform:scale(1,1);-moz-transform:scale(1,1);transform:scale(1,1);}",this.model.get("frontPage")||($(this.removedPage).insertBefore($(".slide").eq(0)),this.model.set("currentPage",this.model.get("currentPage")+1));var e=$("#pages .slide").eq(this.model.get("currentPage")).position(),t=this.removedPageHt?this.removedPageHt:0;"slide"===this.model.get("mode")?$("#pages").scrollLeft(e.left+t):$("body").scrollTop(e.top+t)},goToPage:function(e){function t(){$("#pages .slide").eq(e).find(".page-no.fs").toggle()}if(e<this.model.get("pages")){$("#pages .slide").removeClass("current"),$("#pages .slide").eq(e).addClass("current").fadeIn();var s=$("#pages .slide").eq(e).find(".page-no.fs");s.is(":visible")?setTimeout(t,1e3):(t(),setTimeout(t,1e3)),this.model.get("frontPage")&&0===e&&this.fitTitle($("#filename")),this.model.set("currentPage",e)}},keyHandler:function(e){switch(e.which){case 13:if(e.ctrlKey||e.metaKey){if($("#fullscreen").is(":visible"))return;if(!this.model.get("myFullscreen"))return this.fullscreenHandler()}break;case 35:if(screenfull.isFullscreen)return this.goToPage(this.model.get("pages")-1);break;case 36:if(screenfull.isFullscreen)return this.goToPage(0);break;case 37:if(screenfull.isFullscreen&&this.model.get("currentPage")>0)return this.goToPage(this.model.get("currentPage")-1);break;case 39:case 32:if(screenfull.isFullscreen)return e.preventDefault(),this.model.get("currentPage")+1===this.model.get("pages")?screenfull.toggle($("#pages")[0]):this.goToPage(this.model.get("currentPage")+1);break;case 38:if(screenfull.isFullscreen&&e.metaKey)return this.goToPage(0);break;case 40:if(screenfull.isFullscreen&&e.metaKey)return this.goToPage(this.model.get("pages")-1);break;case 68:var t=$("input[name=onoffswitch]");t.prop("checked",!t.prop("checked")),$(".onoffswitch").trigger("click")}},drawCanvas:function(){function e(e){var t=e.canvas.height,s=e.canvas.width;e.clearRect(0,0,s,t)}function t(e,t){return this.color=e,this.linewidth=t,this.points=[],this}function s(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function i(e,t){var s={};if(s.x=e.pageX-t.left,s.y=e.pageY-t.top,a.model.get("myFullscreen")){var i=document.querySelector(".current"),n=i.getBoundingClientRect().width/i.offsetWidth;isNaN(n)||(s.x/=n,s.y/=n)}return s}function n(e,t){var i,n,r,o;if(t.lineWidth=e.linewidth,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e.color,t.beginPath(),o=e.getPoints(),o.length&&o[0]&&o[1]){for(n=0,to$=o.length-2;n<=to$;++n)i=n,r=s(o[i],o[i+1]),t.quadraticCurveTo(o[i].x,o[i].y,r.x,r.y);t.stroke()}}function r(e,t){for(var s=0,i=e.length;i>s;s++)n(e[s],t)}function o(s){var o=$(s).find(".base"),l=$(s).find(".overlay"),c=o[0].getContext("2d"),h=l[0].getContext("2d"),d=!1,u={},g=new Array,p={x:null,y:null},f={x:null,y:null};return l.on("touchstart mousedown",function(e){d=!0,$(".draw.overlay").removeClass("active"),$(this).addClass("active"),f=$(this).parent().offset(),"touchstart"===e.type&&(e=e.originalEvent.touches[0]),p=i(e,f),u=new t(a.model.get("canvasColor"),a.model.get("canvasLineWidth"))}),l.on("touchmove mousemove",function(t){t.stopPropagation(),t.preventDefault(),d&&("touchstart"===t.type&&(t=t.originalEvent.touches[0]),p=i(t,f),u.pushPoint(p),e(h),n(u,h))}),l.on("touchend mouseup",function(t){t.stopPropagation(),t.preventDefault(),d&&(d=!1,g.push(u),e(h),e(c),r(g,c))}),l.on("mouseleave",function(){d&&(d=!1,g.push(u),e(h),e(c),r(g,c))}),$(document).keydown(function(t){switch(t.stopPropagation(),t.which){case 67:e(h),e(c),g=new Array,r(g,c);break;case 87:a.model.set("canvasColor",a.hex2rgb("#ffcc00",1)),a.model.set("canvasLineWidth",2);break;case 89:a.model.set("canvasColor",a.hex2rgb("#ffcc00",.5)),a.model.set("canvasLineWidth",21);break;case 79:a.model.set("canvasColor",a.hex2rgb("#ff9900",.5)),a.model.set("canvasLineWidth",21);break;case 82:a.model.set("canvasColor",a.hex2rgb("#ff0000",1)),a.model.set("canvasLineWidth",8);break;case 66:t.shiftKey?(a.model.set("canvasColor",a.hex2rgb("#0000ff",1)),a.model.set("canvasLineWidth",2)):(a.model.set("canvasColor",a.hex2rgb("#000000",1)),a.model.set("canvasLineWidth",2));break;case 77:a.model.set("canvasColor",a.hex2rgb("#ff00ff",1)),a.model.set("canvasLineWidth",2);break;case 71:a.model.set("canvasColor",a.hex2rgb("#2c6700",.5)),a.model.set("canvasLineWidth",21)}}),this}var a=this;t.prototype={pushPoint:function(e){return this.points.push(e)},getPoints:function(){return this.points}},$.each($(".slide").has(".draw"),function(e,t){new o($(t))})},resizecanvas:function(){$.each($(".draw"),function(e,t){$(t).resizeCanvas($(".slide").width(),$(".slide").height())})},toggleLike:function(){var e=this.$el.find("#like");this.model.get("liked")?(e.find("i").removeClass("icon-star-empty").addClass("icon-star"),e.find("span").text("Unlike")):(e.find("i").addClass("icon-star-empty").removeClass("icon-star"),e.find("span").text("Like")),$("span#likes").text(this.model.get("likes"))},initialize:function(){this.model=new App.Viewer.Models.raindrop,this.model.set("frontPage",!0),this.model.set("myFullscreen",!1),this.model.set("liked",1===rd.liked?!0:!1),this.model.set("fullscreen",1===rd.fs?!0:!1),this.model.set("user",rd.user),this.model.set("id",rd.id),this.model.set("server",rd.server),this.model.set("mode",rd.type),this.model.set("likes",rd.likes),this.model.set("name",rd.name),this.model.set("author",rd.author),this.model.set("print",rd.print);var e=_.extend({},Backbone.Events);this.vent=e,new App.Viewer.Views.HeaderView({model:{user:loggeduser,get:function(e){return this[e]}},page:"dashboard",vent:this.vent}),this.removedPage="",this.listenTo(this.model,"change:liked",this.toggleLike),"notes"===this.model.get("mode")||this.model.get("print")||(this.swipeOptions={allowPageScroll:"vertical",swipe:function(e,s){var i,n;if(i=$(this),i.hasClass("current"))if("left"===s){if(screenfull.isFullscreen)return n=jQuery(".all_pages"),t.model.get("currentPage")+1===t.model.get("pages")?(t.model.set("currentPage",0),screenfull.toggle(n[0])):t.goToPage(t.model.get("currentPage")+1)}else{if("right"!==s)return!0;if(screenfull.isFullscreen&&t.model.get("currentPage")>0)return t.goToPage(t.model.get("currentPage")-1)}},threshold:0});var t=this;this.style=document.createElement("style"),document.head.appendChild(this.style),this.fitTitle($("#filename")),this.checkMath(),this.model.get("print")||(new App.Viewer.Views.ShareView({model:this.model,vent:this.vent}),_.bindAll(this,"keyHandler"),$(document).bind("keydown",this.keyHandler),this.shareButtons(),this.fbPublish(!1),this.toggleLike(),$("#popuptext").val(this.getEmbedTemplate().replace("{{width}}",560).replace("{{height}}",315))),"notes"===this.model.get("mode")||this.model.get("print")||(this.resizecanvas(),this.drawCanvas()),screenfull.onchange=function(){t.setToFullscreen()},$(window).on("orientationchange",function(){screenfull.isFullscreen&&setTimeout(function(){t.enterFullScreen()},500)}),$(window).resize(function(){t.fitTitle($("#filename"))}),$(window).on("orientationchange resize",function(){t.checkMath()}),$("#banner").hide();var s=document.querySelector("#thumbnails"),i=s.getBoundingClientRect().width/s.offsetWidth;$("#thumbnails").height($("#thumbnails").height()*i+100)}}),_.extend(App.Viewer.Views.ScrollView.prototype,App.Viewer.Utils),App.Viewer.Views.EmbedView=Backbone.View.extend({el:"body",events:{"click #slide-prev":"prevPage","click #slide-next":"nextPage","click #open-fullscreen":"goFullscreen"},prevPage:function(){this.showPage(this.model.get("currentPage")-1)},nextPage:function(){this.showPage(this.model.get("currentPage")+1)},goFullscreen:function(e){if(e.preventDefault(),Modernizr.Touch){var t=navigator.userAgent.toLowerCase(),s=t.indexOf("android")>-1;s&&this.fullscreenHandler(!0)}this.fullscreenHandler(!0)},setToFullscreen:function(){function e(){t.model.set("math",!0)}var t=this;screenfull.isFullscreen&&this.model.get("myFullscreen")?(this.model.get("math")||(MathJax.Hub.Queue(["Reprocess",MathJax.Hub,"pages"]),MathJax.Hub.Queue(e)),this.enterFullScreen()):this.exitFullScreen()},fullscreenHandler:function(){this.model.get("myFullscreen")||(this.model.set("myFullscreen",!0),screenfull.toggle($("#current")[0]))},enterFullScreen:function(){this.model.set("myFullscreen",!0);{var e=window.screen.width,t=window.screen.height,s=1,i=0;$("#current").width(),$("#current").height()}$("#current").toggleClass("border"),s=e/t>16/9?t/396:e/704,i=(t-396*s)/2,this.model.get("math")||MathJax.Hub.Queue(["Reprocess",MathJax.Hub,"pages"]),$(".page").swipe(this.swipeOptions),this.style.innerHTML="body,body.dark{background:black;}.section{margin:0px;position:absolute;top:0px;left:0px;background:rgba(0,0,0,0);} .page-no{z-index:10000} .left-slide{ display:none}#sharePlugin{display:none} .slide{position:fixed;top:0px;left:0px;} .slide:not(.current){display:none;}  #current{-webkit-transform:scale("+s+","+s+");-o-transform:scale("+s+","+s+");-moz-transform:scale("+s+","+s+");transform:scale("+s+","+s+");margin:0px;position:absolute;top:"+Math.floor(i)+"px; transform-origin: top left;z-index:999;}",this.scaler(s)},exitFullScreen:function(){this.model.set("myFullscreen",!1),this.style.innerHTML=".current{-webkit-transform:scale(1,1);-o-transform:scale(1,1);-moz-transform:scale(1,1);transform:scale(1,1);}",this.scaler(this.ratio)},showPage:function(e){function t(e,t){screenfull.isFullscreen?t.html(e):t.hide().html(e).fadeIn()}0>e||e>this.pages.length||(t($(".page").eq(e).html(),this.current.find("div")),0===e?(this.prevSlide.prop("disabled",!0),this.prevSlide.addClass("disabled")):(this.prevSlide.prop("disabled",!1),this.prevSlide.removeClass("disabled")),3>e&&(this.fitTitle(this.prev1),this.fitTitle(this.prev2),this.fitTitle(this.current)),e===this.model.get("pages")-1?(this.nextSlide.prop("disabled",!0),this.nextSlide.addClass("disabled")):(this.nextSlide.prop("disabled",!1),this.nextSlide.removeClass("disabled")),this.model.set("currentPage",e),this.current=this.$el.find("#current"))},scaler:function(e){this.current.css("-webkit-transform","scale("+e+")"),this.current.css("-moz-transform","scale("+e+")"),this.current.css("-ms-transform","scale("+e+")"),this.current.css("-o-transform","scale("+e+")"),this.current.css("transform","scale("+e+")")},keyHandler:function(e){switch(e.which){case 13:if(e.ctrlKey||e.metaKey){if($("#fullscreen").is(":visible"))return;if(!this.model.get("myFullscreen"))return this.fullscreenHandler()}break;case 35:return this.showPage(this.model.get("pages")-1);case 36:return this.showPage(0);case 37:if(this.model.get("currentPage")>0)return this.showPage(this.model.get("currentPage")-1);break;case 39:case 32:if(e.preventDefault(),this.model.get("currentPage")<this.model.get("pages")-1)return this.showPage(this.model.get("currentPage")+1);if(this.model.get("myFullscreen"))return screenfull.toggle($("#current")[0]);break;case 38:if(e.metaKey)return this.showPage(0);break;case 40:if(e.metaKey)return this.showPage(this.model.get("pages")-1)}},initialize:function(){this.model=new App.Viewer.Models.raindrop,this.model.set("fullscreen",1===rd.fs?!0:!1),this.model.set("frontPage",1===rd.fp?!0:!1),this.model.set("myFullscreen",!1),this.model.set("id",rd.id),this.model.set("server",rd.server),this.model.set("mode",rd.type),this.model.set("embed",rd.embed),this.removedPage="",this.swipeOptions={allowPageScroll:"vertical",swipe:function(t,s){var i,n;if(i=$(this),i.hasClass("current"))if("left"===s){if(screenfull.isFullscreen)return n=jQuery(".all_pages"),e.model.get("currentPage")+1===e.model.get("pages")?(e.model.set("currentPage",0),screenfull.toggle(n[0])):e.goToPage(e.model.get("currentPage")+1)}else{if("right"!==s)return!0;if(screenfull.isFullscreen&&e.model.get("currentPage")>0)return e.goToPage(e.model.get("currentPage")-1)}},threshold:0};var e=this;this.style=document.createElement("style"),document.head.appendChild(this.style),_.bindAll(this,"keyHandler"),$(document).bind("keydown",this.keyHandler),this.checkMath(),screenfull.onchange=function(){e.setToFullscreen()},$(window).on("orientationchange",function(){screenfull.isFullscreen&&setTimeout(function(){e.enterFullScreen()},500)}),$(window).on("orientationchange resize",function(){e.checkMath()}),this.pages=$(".page"),this.model.set("pages",this.pages.length),this.current=this.$el.find("#current"),this.prevSlide=this.$el.find("#slide-prev"),this.nextSlide=this.$el.find("#slide-next"),this.showPage(0),"notes"===this.model.get("mode")&&(this.current.css("height","auto"),this.prevSlide.hide(),this.nextSlide.hide(),$("#open-fullscreen").hide());var t=$(window).width(),s=9*t/16;window.resizeTo(t,s),s=9*t/16,this.ratio=t/704,$("#banner").hide(),this.scaler(this.ratio)}}),_.extend(App.Viewer.Views.EmbedView.prototype,App.Viewer.Utils),App.Viewer.Views.StudyView=Backbone.View.extend({el:"body",events:{"click #slide-prev":"prevPage","click #slide-next":"nextPage","click #slide-num":"goPage","keypress #current-page-number":"goToPage","blur #current-page-number":"blurPageNo","click #backlight":"toggleBackLight","click #open-fullscreen":"goFullscreen","click #scroll":"openScrollMode","click .bm":"swapBookmark"},bookmarkPage:function(e){if(e=parseInt(e),!isNaN(e)&&!(e>2||1>e)){var t="";1===e?t=$("#bm1"):2===e&&(t=$("#bm2"));var s=this.model.get("currentPage");t.data("page",s),t.html($(".page").eq(s).html())}},swapBookmark:function(e){var t=$(e.currentTarget),s=t.data("page");s&&(t.html($(".page").eq(this.model.get("currentPage")).html()),t.data("page",this.model.get("currentPage")),this.showPage(s))},toggleBackLight:function(e){e.preventDefault();var t=$(e.currentTarget);t.toggleClass("on").toggleClass("off"),this.$el.toggleClass("dark")},prevPage:function(){this.showPage(this.model.get("currentPage")-1)},nextPage:function(){this.showPage(this.model.get("currentPage")+1)},goToPage:function(e){var t=$(e.currentTarget);if(t.prop("contenteditable")&&13===e.which){e.preventDefault(),t.prop("contenteditable",!1);var s=parseInt(t.html());if(isNaN(s))return this.showPage(this.model.get("currentPage"));if(s>this.pages.length-1)return this.showPage(this.model.get("currentPage"));if(s!==this.model.get("currentPage"))return this.showPage(s)}},blurPageNo:function(e){var t=$(e.currentTarget);if(e.stopPropagation(),t.prop("contenteditable")){t.prop("contenteditable",!1);var s=parseInt(t.html());return isNaN(s)?this.showPage(this.model.get("currentPage")):s>this.pages.length-1?this.showPage(this.model.get("currentPage")):s!==this.model.get("currentPage")?this.showPage(s):void 0}},goPage:function(){this.currentPageSpan.prop("contenteditable",!0),this.currentPageSpan.focus(),this.currentPageSpan.select()},goFullscreen:function(e){if(e.preventDefault(),Modernizr.Touch){var t=navigator.userAgent.toLowerCase(),s=t.indexOf("android")>-1;s&&this.fullscreenHandler(!0)}this.fullscreenHandler(!0)},setToFullscreen:function(){function e(){t.model.set("math",!0)}var t=this;screenfull.isFullscreen&&this.model.get("myFullscreen")?(this.model.get("math")||(MathJax.Hub.Queue(["Reprocess",MathJax.Hub,"pages"]),MathJax.Hub.Queue(e)),this.enterFullScreen()):this.exitFullScreen()},fullscreenHandler:function(){this.model.get("myFullscreen")||(this.model.set("myFullscreen",!0),screenfull.toggle($("#current")[0]))},enterFullScreen:function(){this.model.set("myFullscreen",!0);var e=window.screen.width,t=window.screen.height,s=1,i=0,n=$("#current").width(),r=$("#current").height();$("#current").toggleClass("border"),s=e/t>16/9?t/r:e/n,i=(t-s*r)/2,this.model.get("math")||MathJax.Hub.Queue(["Reprocess",MathJax.Hub,"pages"]),$(".page").swipe(this.swipeOptions),this.style.innerHTML="body,body.dark{background:black;}.section{margin:0px;position:absolute;top:0px;left:0px;background:rgba(0,0,0,0);} .page-no{z-index:10000} .left-slide{ display:none}#sharePlugin{display:none} .slide{position:fixed;top:0px;left:0px;} .slide:not(.current){display:none;}  #current{-webkit-transform:scale("+s+","+s+");-o-transform:scale("+s+","+s+");-moz-transform:scale("+s+","+s+");transform:scale("+s+","+s+");margin:0px;position:absolute;top:"+Math.floor(i)+"px; transform-origin: top left;}#pages #current{padding:0}",this.goToPage(this.model.get("currentPage"))},exitFullScreen:function(){this.model.set("myFullscreen",!1),$("#current").toggleClass("border"),this.style.innerHTML=".current{-webkit-transform:scale(1,1);-o-transform:scale(1,1);-moz-transform:scale(1,1);transform:scale(1,1);}"},showPage:function(e){function t(e,t){screenfull.isFullscreen?t.html(e):t.hide().html(e).fadeIn()}0>e||e>this.pages.length||(e>0?t($(".page").eq(e-1).html(),this.prev2):t("",this.prev2),e>1?t($(".page").eq(e-2).html(),this.prev1):t("",this.prev1),t($(".page").eq(e).html(),this.current.find("div")),0===e?(this.prevSlide.prop("disabled",!0),this.prevSlide.addClass("disabled")):(this.prevSlide.prop("disabled",!1),this.prevSlide.removeClass("disabled")),3>e&&(this.fitTitle(this.prev1),this.fitTitle(this.prev2),this.fitTitle(this.current)),e===this.model.get("pages")-1?(this.nextSlide.prop("disabled",!0),this.nextSlide.addClass("disabled")):(this.nextSlide.prop("disabled",!1),this.nextSlide.removeClass("disabled")),this.model.set("currentPage",e),this.currentPageSpan.text(e))},pinPage:function(){this.model.get("pinPage")?(this.showPage(this.model.get("pinPage")),this.model.set("pinPage",void 0),$("#pin").hide()):(this.model.set("pinPage",this.model.get("currentPage")),$("#pin").show())},keyHandler:function(e){switch(e.which){case 13:if(e.ctrlKey||e.metaKey){if($("#fullscreen").is(":visible"))return;if(!this.model.get("myFullscreen"))return this.fullscreenHandler()}break;case 35:return this.showPage(this.model.get("pages")-1);case 36:return this.showPage(0);case 37:if(this.model.get("currentPage")>0)return this.showPage(this.model.get("currentPage")-1);break;case 39:case 32:if(e.preventDefault(),this.model.get("currentPage")<this.model.get("pages")-1)return this.showPage(this.model.get("currentPage")+1);if(this.model.get("myFullscreen"))return screenfull.toggle($("#current")[0]);break;case 38:if(e.metaKey)return this.showPage(0);break;case 40:if(e.metaKey)return this.showPage(this.model.get("pages")-1);break;case 49:return e.ctrlKey?this.bookmarkPage(1):!0;case 50:return e.ctrlKey?this.bookmarkPage(2):!0;case 80:return this.pinPage()}},initialize:function(){this.model=new App.Viewer.Models.raindrop,this.model.set("fullscreen",1===rd.fs?!0:!1),this.model.set("frontPage",1===rd.fp?!0:!1),this.model.set("myFullscreen",!1),this.model.set("authors",rd.authors),this.model.set("id",rd.id),this.model.set("server",rd.server),this.model.set("mode",rd.type),this.removedPage="",this.swipeOptions={allowPageScroll:"vertical",swipe:function(t,s){var i,n;if(i=$(this),i.hasClass("current"))if("left"===s){if(screenfull.isFullscreen)return n=jQuery(".all_pages"),e.model.get("currentPage")+1===e.model.get("pages")?(e.model.set("currentPage",0),screenfull.toggle(n[0])):e.goToPage(e.model.get("currentPage")+1)}else{if("right"!==s)return!0;if(screenfull.isFullscreen&&e.model.get("currentPage")>0)return e.goToPage(e.model.get("currentPage")-1)}},threshold:0};var e=this;this.style=document.createElement("style"),document.head.appendChild(this.style),_.bindAll(this,"keyHandler"),$(document).bind("keydown",this.keyHandler),this.checkMath(),this.shareButtons(),this.fbPublish(),screenfull.onchange=function(){e.setToFullscreen()
},$(window).on("orientationchange",function(){screenfull.isFullscreen&&setTimeout(function(){e.enterFullScreen()},500)}),$(window).on("orientationchange resize",function(){e.checkMath()}),this.pages=$(".page"),this.model.set("pages",this.pages.length),this.listenTo(this.model,"change:currentPage",this.changePageNo),this.current=this.$el.find("#current"),this.prev1=this.$el.find("#prev1"),this.prev2=this.$el.find("#prev2"),this.prevSlide=this.$el.find("#slide-prev"),this.nextSlide=this.$el.find("#slide-next"),this.totalPageSpan=this.$el.find("#total-page-number"),this.currentPageSpan=this.$el.find("#current-page-number"),this.currentPageSpan.text(0),this.totalPageSpan.text(this.pages.length-1),this.showPage(0),$("#help").click(function(){var e,t;e=$(".subhelp"),e.slideDown(500),0!==$("#help:hover").length?$(this).on("mouseleave",function(){e.slideUp(500,function(){$(this).on("mouseenter",!0)})}):(t=function(){e.slideUp(500,function(){$(this).on("mouseenter",!0)})},self.setTimeout(t,600))}),$("#banner").hide()},changePageNo:function(){this.currentPageSpan.text(this.model.get("currentPage"))}}),_.extend(App.Viewer.Views.StudyView.prototype,App.Viewer.Utils),App.Viewer.Views.HeaderView=Backbone.View.extend({el:"#header",setupDOM:function(){this.rightContainer=this.$el.find("#right"),this.searchContainer=this.$el.find("#search"),this.searchInput=$(".search",this.searchContainer),this.searchHelp=$(".searchhelp",this.searchContainer);var e=this.rightContainer.find("#drop");e.is(":visible")&&e.css("background-image",e.css("background-image").replace("/)","?dummy="+(new Date).getTime()+"/)"))},events:{"focus input.search":"expandSearchForSmall","blur input.search":"closeExpandForSmall","keyup input.search":"keyHandler","click #drop":"toggleDropDown","keyup input.search":"showSearch","click input.search":"showSearch","click #search":"stop","click .searchhelp":"searchPage","click .new-rd":"createNewRaindrop"},createNewRaindrop:function(e){e.stopPropagation();var t={pos:$("#top").outerHeight(!0)};this.vent.trigger("loadCreate",t)},stop:function(e){e.stopPropagation()},searchPage:function(e){var t=(window.location.origin+window.location.pathname+"#",$(e.currentTarget));this.searchHelp.removeClass("select"),t.addClass("select"),this.searchHelp.eq(0).is(".select")?(q=this.searchInput.val().substr(this.searchInput.val().indexOf(" ")+1),this.searchHash(q,this.searchHelp.eq(0).data("user"))):this.searchHash(this.searchInput.val()),this.searchHelp.removeClass("select")},toggleDropDown:function(e){e.stopPropagation();var t=$(e.currentTarget),s=t.offset();s.top+=t.height()+16;var i=-1*(t.width()/2+parseInt(t.css("margin-Right"),10)+2);$("#profile-menu").css({left:i+30,top:s.top}),$("#profile-menu").toggle()},searchHash:function(e,t){t?"search"===this.page?window.location.hash="@"+t+" "+e:window.location.href="../../search#@"+t+" "+e:"search"===this.page?window.location.hash=e:window.location.href="../../search#"+e},showSearch:function(e){var t=$(e.currentTarget);if(""!==t.val().trim()){if("@"!==t.val().charAt(0))this.searchHelp.find(".searchtext").text(t.val()),this.searchHelp.find(".searchuser").text("my"),this.searchHelp.eq(0).data("user",loggeduser);else if(-1!==t.val().indexOf(" ")){var s=t.val().split(" ")[0].substr(1),i=t.val().substr(t.val().indexOf(" ")+1);this.searchHelp.find(".searchtext").text(i),this.searchHelp.eq(0).data("user",s),this.searchHelp.find(".searchuser").text(s!==loggeduser?s+"'s":"my")}else this.searchHelp.find(".searchtext").text(t.val()),this.searchHelp.find(".searchuser").text("my"),this.searchHelp.eq(0).data("user",loggeduser);this.searchHelp.show(),this.searchInput.addClass("dropdown")}else this.searchHelp.hide(),this.searchHelp.removeClass("select"),this.searchInput.removeClass("dropdown");if(13===e.which){{window.location.origin+window.location.pathname+"#"}this.searchHelp.eq(0).is(".select")?(i=t.val().substr(t.val().indexOf(" ")+1),this.searchHash(i,this.searchHelp.eq(0).data("user"))):this.searchHash(t.val()),this.searchHelp.removeClass("select"),this.searchHelp.hide(),this.searchHelp.removeClass("select"),this.searchInput.removeClass("dropdown")}27===e.which&&(this.searchHelp.hide(),this.searchHelp.removeClass("select"),this.searchInput.removeClass("dropdown")),38===e.which&&(e.preventDefault(),this.searchHelp.eq(1).hasClass("select")&&(this.searchHelp.removeClass("select"),this.searchHelp.eq(0).addClass("select"))),40===e.which&&(e.preventDefault(),this.searchHelp.eq(0).hasClass("select")?(this.searchHelp.removeClass("select"),this.searchHelp.eq(1).addClass("select")):(this.searchHelp.removeClass("select"),this.searchHelp.eq(0).addClass("select")))},hideSearch:function(){this.searchHelp.hide(),this.searchInput.removeClass("dropdown")},keyHandler:function(e){var t=$(e.currentTarget);return 27===e.which?t.trigger("blur"):void 0},expandSearchForSmall:function(e){var t=$(e.currentTarget);t.parent().hasClass("full")||(this.rightContainer.addClass("hide"),this.searchContainer.addClass("full")),""!==t.val().trim()&&(this.searchHelp.show(),this.searchInput.addClass("dropdown"))},closeExpandForSmall:function(){this.rightContainer.removeClass("hide"),this.searchContainer.removeClass("full")},initialize:function(e){this.setupDOM(),this.vent=e.vent;var t=this;this.page=e.page,$(document).click(function(){t.searchHelp.hide(),t.searchInput.removeClass("dropdown")})}});